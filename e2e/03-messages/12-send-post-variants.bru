meta {
  name: Send Post Variants (多种内容类型)
  type: http
  seq: 12
}

post {
  url: {{feishu_base_url}}/open-apis/im/v1/messages?receive_id_type=chat_id
  body: json
  auth: bearer
}

auth:bearer {
  token: {{tenant_access_token}}
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "receive_id": "{{test_chat_id}}",
    "msg_type": "post",
    "content": "{\"zh_cn\":{\"content\":[[{\"tag\":\"text\",\"text\":\"[E2E] E2E-03-12 富文本全类型覆盖测试\"}],[{\"tag\":\"md\",\"text\":\"## 1. 文本格式\"}],[{\"tag\":\"md\",\"text\":\"**加粗** *斜体* ~~删除线~~\"}],[{\"tag\":\"md\",\"text\":\"## 2. 代码块\"}],[{\"tag\":\"md\",\"text\":\"```js\\nconst x = 1;\\nconsole.log(x);\\n```\"}],[{\"tag\":\"md\",\"text\":\"## 3. 列表\"}],[{\"tag\":\"md\",\"text\":\"- 无序项 A\\n- 无序项 B\\n- 无序项 C\"}],[{\"tag\":\"md\",\"text\":\"1. 有序项 一\\n2. 有序项 二\\n3. 有序项 三\"}],[{\"tag\":\"md\",\"text\":\"---\"}],[{\"tag\":\"md\",\"text\":\"## 4. 架构图 (Mermaid)\"}],[{\"tag\":\"md\",\"text\":\"```mermaid\\ngraph LR\\n  A[用户] --> B[API]\\n  B --> C[数据库]\\n  C --> D[缓存]\\n```\"}],[{\"tag\":\"md\",\"text\":\"## 5. ASCII 架构图\"}],[{\"tag\":\"md\",\"text\":\"```\\n  +--------+      +--------+\\n  |  前端   | ----> |  后端   |\\n  +--------+      +--------+\\n```\"}],[{\"tag\":\"a\",\"text\":\"飞书开放平台\",\"href\":\"https://open.feishu.cn\"}],[{\"tag\":\"text\",\"text\":\"--- [E2E] E2E-03-12 全类型覆盖，回复可确认真实情况 ---\"}]]}}"
  }
}

assert {
  res.status: eq 200
  res.body.code: eq 0
  res.body.data.message_id: isDefined
}

script:pre-request {
  const token = bru.getEnvVar("tenant_access_token");
  if (!token) {
    throw new Error("No token. Run 01-auth first.");
  }
}

script:post-response {
  if (res.body.code === 0) {
    console.log("✓ Post variants sent successfully");
    console.log("  Message ID:", res.body.data?.message_id);
    console.log("  覆盖: text/md/a + 加粗斜体删除线 + 代码块 + 列表 + 分割线 + Mermaid架构图 + ASCII图");
  }
}

tests {
  test("should send post with multiple content types", function() {
    expect(res.body.code).to.equal(0);
    expect(res.body.data).to.have.property('message_id');
  });

  test("message_id should be valid format", function() {
    expect(res.body.data.message_id).to.match(/^om_/);
  });
}

docs {
  # 富文本全类型覆盖 Post 发送

  发送一条富文本消息，覆盖飞书 post 支持的各类内容：

  | 类型 | 示例 |
  |------|------|
  | text | 纯文本 |
  | md | **加粗** *斜体* ~~删除线~~ |
  | md | ## 标题 |
  | md | 代码块 ```js |
  | md | 无序/有序列表 |
  | md | 分割线 --- |
  | md | Mermaid 架构图 (graph LR) |
  | md | ASCII 架构图 |
  | a | 链接 |

  用于在飞书客户端验证各类型渲染效果。
}
