meta {
  name: Empty Allowlist (Deny All)
  type: http
  seq: 4
}

post {
  url: {{zeroclaw_gateway_url}}/webhook
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "schema": "2.0",
    "header": {
      "event_id": "test_empty_allowlist_{{$randomInt}}",
      "event_type": "im.message.receive_v1",
      "create_time": "{{$timestamp}}",
      "token": "test",
      "app_id": "{{app_id}}",
      "tenant_key": "test"
    },
    "event": {
      "sender": {
        "sender_id": {
          "open_id": "ou_any_user_{{$randomInt}}"
        }
      },
      "message": {
        "message_id": "om_empty_allow_test",
        "chat_id": "{{test_chat_id}}",
        "chat_type": "p2p",
        "message_type": "text",
        "content": "{\"text\":\"[E2E] E2E-04-04 Should be rejected\"}"
      }
    }
  }
}

tests {
  test("ASR-004: empty allowlist should deny everyone", function() {
    // This test assumes allowed_users = [] in config
    // Webhook returns 200 but message is dropped internally
    expect(res.status).to.equal(200);
  });
}

docs {
  # ASR-004: ç©º Allowlist é»˜è®¤æ‹’ç»
  
  **æ¶æ„é‡è¦éœ€æ±‚**: ASR-004 æœªåœ¨ allowlist çš„é£ä¹¦ç”¨æˆ·æ¶ˆæ¯è¢«é™é»˜ä¸¢å¼ƒ
  **é…ç½®**: `allowed_users = []`
  **è¡Œä¸º**: æ‹’ç»æ‰€æœ‰å…¥ç«™æ¶ˆæ¯
  
  ## éªŒæ”¶æ¡ä»¶
  
  ```gherkin
  Given allowed_users = []
  When æ”¶åˆ°ä»»æ„ç”¨æˆ·æ¶ˆæ¯
  Then æ¶ˆæ¯è¢«ä¸¢å¼ƒ
  And æ—¥å¿—è¾“å‡º warn
  ```
  
  ## é»˜è®¤å®‰å…¨ç­–ç•¥ï¼ˆADR-004ï¼‰
  
  ZeroClaw æ¸ é“é»˜è®¤é‡‡ç”¨"æ‹’ç»æ‰€æœ‰"åŸåˆ™ï¼š
  
  | Allowlist | è¡Œä¸º | å®‰å…¨çº§åˆ« |
  |-----------|------|---------|
  | `[]` (ç©º) | æ‹’ç»æ‰€æœ‰ | ğŸ”’ æœ€é«˜ |
  | `["ou_abc"]` | ä»…å…è®¸æŒ‡å®šç”¨æˆ· | ğŸ”’ é«˜ |
  | `["*"]` | å…è®¸æ‰€æœ‰ï¼ˆæ˜¾å¼ï¼‰ | âš ï¸ ä½ |
  
  ## å®ç°
  
  ```rust
  // security.rs
  pub fn is_user_allowed(&self, user_id: &str) -> bool {
      self.allowed_users.iter().any(|u| u == "*" || u == user_id)
  }
  ```
  
  ç©ºåˆ—è¡¨: `[].iter().any(...)` â†’ false
  
  ## å‚è€ƒ
  
  - å¯¹æ¯” Telegram/Slack/Discord ä¸€è‡´çš„ allowlist è¡Œä¸º
  - channels/telegram.rs:27-29
}
