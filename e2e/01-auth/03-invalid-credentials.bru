meta {
  name: Auth Error - Invalid Credentials
  type: http
  seq: 3
}

post {
  url: {{feishu_base_url}}/open-apis/auth/v3/tenant_access_token/internal
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "app_id": "cli_invalid_app_id_000",
    "app_secret": "invalid_secret_for_error_test"
  }
}

assert {
  res.status: eq 200
  res.body.code: gt 0
}

script:post-response {
  console.log("✓ Invalid credentials correctly rejected");
  console.log("  HTTP Status:", res.status);
  console.log("  Error code:", res.body.code);
  console.log("  Error msg:", res.body.msg);
}

tests {
  test("should reject invalid app_id + app_secret", function() {
    expect(res.body.code).to.not.equal(0);
  });

  test("should return meaningful error code", function() {
    // 10003 = invalid app_id, 10014 = invalid app_secret
    expect(res.body.code).to.be.greaterThan(0);
  });

  test("should include error message", function() {
    expect(res.body.msg).to.be.a('string');
    expect(res.body.msg.length).to.be.greaterThan(0);
  });

  test("should respond quickly even on error", function() {
    expect(res.responseTime).to.be.lessThan(3000);
  });
}

docs {
  # Auth Error Path - Invalid Credentials

  Validates the error handling when invalid app_id/app_secret are used.
  Maps to: `FeishuError::TokenFetchFailed` in the domain error model.

  ## Architecture mapping

  ```
  LarkAuthAdapter::get_token()
    → TokenManager::get_tenant_access_token()
      → POST /auth/v3/tenant_access_token/internal  (this test)
      → code != 0 → Err(FeishuError::TokenFetchFailed(msg))
  ```
}
