meta {
  name: ZeroClaw Webhook Message Forward
  type: http
  seq: 2
}

post {
  url: {{zeroclaw_gateway_url}}/webhook
  body: json
  auth: bearer
}

auth:bearer {
  token: test_bearer_token_replace_with_real
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "message": "Test message from Bruno to ZeroClaw",
    "channel": "feishu",
    "sender": "{{test_user_open_id}}"
  }
}

assert {
  res.status: eq 200
}

script:pre-request {
  console.log("ℹ Testing ZeroClaw webhook integration");
  console.log("  Endpoint:", bru.getEnvVar("zeroclaw_gateway_url") + "/webhook");
  console.log("");
  console.log("⚠ Note: This requires:");
  console.log("  1. Gateway pairing completed (POST /pair)");
  console.log("  2. Valid bearer token");
  console.log("  3. Feishu channel enabled in config");
}

script:post-response {
  if (res.status === 200) {
    console.log("✓ Message forwarded to ZeroClaw");
    console.log("  Status:", res.status);
  } else if (res.status === 401) {
    console.error("✗ Unauthorized - missing or invalid bearer token");
    console.error("  Run gateway pairing first: POST /pair with X-Pairing-Code");
  } else if (res.status === 403) {
    console.error("✗ Forbidden - pairing required");
  } else {
    console.error("✗ Webhook failed:", res.status);
  }
}

tests {
  test("should accept webhook message", function() {
    // 200/202 = accepted
    // 401/403 = auth issue (expected if not paired)
    expect(res.status).to.be.oneOf([200, 202, 401, 403]);
  });
  
  test("should validate message format", function() {
    // Request body format: { message, channel, sender }
    // bru.getRequestBody() is unavailable in safe sandbox (Bruno v3+)
    // The webhook should accept or reject the request properly
    expect(res.status).to.be.oneOf([200, 202, 400, 401, 403]);
  });
}

docs {
  # ZeroClaw Webhook 集成测试
  
  **测试目的**: 验证 ZeroClaw gateway webhook 端点能够接收并处理飞书消息
  
  ## Gateway Pairing 流程
  
  1. 启动 gateway: `zeroclaw gateway --port 8080`
  2. Gateway 输出 6 位 pairing code (例如: `123456`)
  3. Exchange code for token:
  
  ```bash
  curl -X POST http://127.0.0.1:8080/pair \
    -H "X-Pairing-Code: 123456"
  # Returns: {"token": "bearer_abc123..."}
  ```
  
  4. 使用 token 调用 /webhook:
  
  ```bash
  curl -X POST http://127.0.0.1:8080/webhook \
    -H "Authorization: Bearer bearer_abc123..." \
    -H "Content-Type: application/json" \
    -d '{"message":"Hello","channel":"feishu","sender":"ou_xxx"}'
  ```
  
  ## Webhook Payload 格式
  
  ```json
  {
    "message": "消息内容",
    "channel": "feishu",
    "sender": "chat_id 或 open_id"
  }
  ```
  
  ## 安全特性
  
  - require_pairing = true (默认)
  - bearer token 认证
  - 仅 localhost 绑定（除非配置 tunnel）
  
  ## 参考
  
  - gateway/mod.rs::webhook_handler()
  - security/pairing.rs
  - README.md Gateway API
}
