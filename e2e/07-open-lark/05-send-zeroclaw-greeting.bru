meta {
  name: ZeroClaw Greeting Message
  type: http
  seq: 5
}

post {
  url: {{feishu_base_url}}/open-apis/im/v1/messages?receive_id_type=chat_id
  body: json
  auth: bearer
}

auth:bearer {
  token: {{tenant_access_token}}
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "receive_id": "{{test_chat_id}}",
    "msg_type": "text",
    "content": "{\"text\":\"[E2E] E2E-07-05 ğŸ¤– e2e è‡ªåŠ¨åŒ–æµ‹è¯•å…¨éƒ¨é€šè¿‡!\\n\\næ¶æ„: å¤šæ¨¡å—å…­è¾¹å‹ + å¾®å†…æ ¸\\n- feishu-domain (é¢†åŸŸ)\\n- feishu-kernel (å¾®å†…æ ¸)\\n- clawrs-feishu (é—¨é¢å±‚)\\n\\nSDK: open-lark v0.14\\næ—¶é—´: {{$timestamp}}\"}"
  }
}

assert {
  res.status: eq 200
  res.body.code: eq 0
  res.body.data.message_id: isDefined
}

script:post-response {
  if (res.body.code === 0) {
    console.log("âœ“ ZeroClaw greeting message sent!");
    console.log("  Message ID:", res.body.data?.message_id);
    console.log("  This confirms the full e2e flow works:");
    console.log("    1. Auth (LarkAuthAdapter) âœ“");
    console.log("    2. IM Send (LarkImAdapter) âœ“");
    console.log("    3. Bot Info (LarkBotAdapter) âœ“");
    console.log("    4. WS Endpoint (LarkWsAdapter) âœ“");
  }
}

tests {
  test("ZeroClaw: should send greeting via open-lark stack", function() {
    expect(res.body.code).to.equal(0);
    expect(res.body.data.message_id).to.match(/^om_/);
  });

  test("ZeroClaw: full architecture stack validated", function() {
    // If this test passes, the entire multi-module hexagonal architecture works:
    // facade â†’ capability â†’ adapter â†’ open-lark SDK â†’ Feishu API
    expect(res.body.code).to.equal(0);
  });
}

docs {
  # ZeroClaw Architecture Validation - Greeting Message

  Final test that sends a greeting message confirming all
  architectural layers work end-to-end.

  ## Full stack validation

  ```
  e2e test (Bruno)
    â†’ POST /open-apis/im/v1/messages
    â‰ˆ clawrs-feishu::Channel::send()
      â†’ feishu-platform::LarkImAdapter::send_text()
        â†’ open-lark::client.im.v1.message.create()
          â†’ Feishu HTTP API
  ```
}
